using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Text;
using System.Threading.Tasks;
using VulnerabilityPrediction.Logging;

namespace VulnerabilityPrediction.Formatting
{
    
    public class UpdateService
    {
        private WebClient downloader;

        public UpdateService()
        {
            downloader = new WebClient();
        }
        public FileInfo GetLatestInstance()
        {
            string fileName = DateTime.Today.ToOADate() + ".csv";
            try
            {
                downloader.DownloadFile(new Uri(FileManager.LatestDatastore), Path.Combine(Environment.CurrentDirectory, fileName));
            }
            catch (WebException ex)
            {
                Logger.Log(ex);
                throw ex;
            }
            
            return new FileInfo(fileName);
        }

        public void UpdateRecords()
        {
            var connectionString = @"Data Source=(LocalDB)\v11.0;AttachDbFilename=" + Path.Combine(AppDomain.CurrentDomain.BaseDirectory, @"DATA STORES\WAREHOUSE.MDF");
            DatabaseReader r = new DatabaseReader(connectionString);
            var databaseLatest = r.ExecuteQuery("SELECT TOP 1 * FROM v_FullExploits ORDER BY Date Desc").First();

            DatabaseWriter writer = new DatabaseWriter(connectionString);
            UpdateService updater = new UpdateService();
            var latestFile = updater.GetLatestInstance();
            using (CsvReader reader = new CsvReader(latestFile.FullName))
            {
                List<Exploit> list = new List<Exploit>();
                foreach (string[] values in reader.RowEnumerator)
                {
                    list.Add(new Exploit(values));
                }
                foreach (var item in list.OrderByDescending(t => t.DateReleased))
                {
                    if (databaseLatest.DateReleased >= item.DateReleased)
                        break;
                    writer.InsertExploit(item);
                }
            }
            
        }

        public void GetLatestRecords()
        {
            throw new NotImplementedException();
        }
    }
}
