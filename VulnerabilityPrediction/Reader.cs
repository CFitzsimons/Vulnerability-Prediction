using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using VulnerabilityPrediction.Formatting;
using VulnerabilityPrediction.Logging;

namespace VulnerabilityPrediction
{
    class Reader
    {
        public string ConnectionInfo { get; private set; }

        public Reader(string connection)
        {
            ConnectionInfo = connection;
        }

        

        public List<Exploit> ExecuteQuery(SqlCommand cmd)
        {
            var list = new List<Exploit>();
             using (SqlConnection connection = new SqlConnection(ConnectionInfo))
             {
                 cmd.Connection = connection;
                 connection.Open();
                 try
                 {
                     var output = cmd.ExecuteReader();
                     while (output.HasRows)
                     {
                         while (output.Read())
                         {
                             object [] temp = new object[9];
                             output.GetValues(temp);
                             list.Add(new Exploit(temp));
                         }
                         output.NextResult();
                     }
                     return list;
                 }
                 catch (Exception e)
                 {
                     Logger.Log(e);
                     throw e;
                 }
                        
             }
        }

        public List<Exploit> ExecuteQuery(PlatformType platform, ExploitType exploitType)
        {
            /* Special case as the majority of web app results are sql injection and the rest just damages the reading. */
            if (platform == PlatformType.Php && exploitType == ExploitType.WebApps)
                return this.ExecuteQuery(@"SELECT * FROM v_FullExploits WHERE PlatformName = 'Php' AND Description LIKE '%sql%injection%'");
            return this.ExecuteQuery(String.Format(@"SELECT * FROM v_FullExploits WHERE PlatformName = '{0}' AND ExploitType = '{1}'", platform, exploitType));
        }

        public List<Exploit> ExecuteQuery(string query)
        {
            SqlCommand cmd = new SqlCommand(query);
            return ExecuteQuery(cmd);
        }
    }
}
